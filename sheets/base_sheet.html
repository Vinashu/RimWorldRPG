<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RimWorld RPG - Base Sheet</title>
    <meta name="description" content="Interactive character sheet for RimWorld RPG - Base/Colony Management">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <!-- Overview -->
        <header class="panel header-section">
            <div style="flex-grow: 1;">
                <label for="colony-name">Colony Name</label>
                <input type="text" id="colony-name" name="colony-name" placeholder="Hope's End" value="Hope's End"
                    style="font-size: 1.5em; font-weight: bold;" aria-label="Colony Name">
            </div>
            <div style="width: 200px;">
                <label for="biome">Biome</label>
                <input type="text" id="biome" name="biome" value="Arid Shrubland" aria-label="Biome Type">
            </div>
            <div style="width: 150px;">
                <label for="tech-level-display">Tech Level</label>
                <input type="text" id="tech-level-display" name="tech-level" value="Industrial"
                    aria-label="Current Technology Level">
            </div>
        </header>

        <!-- Base Stats -->
        <section class="panel" style="grid-column: span 12;" aria-labelledby="colony-stats-heading">
            <h2 id="colony-stats-heading">Colony Stats</h2>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div class="vital-box" style="border-color: var(--danger);">
                    <label for="security-value">SECURITY</label>
                    <div class="vital-value" id="security-value" aria-label="Security Rating">8</div>
                </div>
                <div class="vital-box" style="border-color: var(--success);">
                    <label for="efficiency-value">EFFICIENCY</label>
                    <div class="vital-value" id="efficiency-value" aria-label="Efficiency Bonus">+1</div>
                </div>
                <div class="vital-box" style="border-color: var(--accent-color);">
                    <label for="comfort-value">COMFORT</label>
                    <div class="vital-value" id="comfort-value" aria-label="Comfort Bonus">+2</div>
                </div>
                <div class="vital-box" style="border-color: var(--warning);">
                    <label for="total-wealth-score">WEALTH SCORE</label>
                    <div class="vital-value" id="total-wealth-score" aria-live="polite" aria-label="Total Wealth Score">
                        57</div>
                    <span style="font-size: 0.7em; color: #888;" id="wealth-tier-quick">Prosperous</span>
                </div>
            </div>
        </section>

        <!-- Wealth Score Calculator -->
        <section class="panel" style="grid-column: span 12;" aria-labelledby="wealth-calculator-heading">
            <h2 id="wealth-calculator-heading">Wealth Score Calculator</h2>
            <form id="wealth-calculator-form" aria-label="Wealth Score Calculator">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <!-- Tech Points -->
                    <fieldset style="border: 1px solid #444; padding: 10px; border-radius: 5px;">
                        <legend style="margin-top: 0; color: var(--accent-color); font-weight: bold;">Tech Points
                        </legend>
                        <label for="tech-neo">Neolithic (1pt/lvl):</label>
                        <input type="number" id="tech-neo" name="tech-neo" value="0" min="0" max="4"
                            aria-label="Neolithic Tech Levels" title="0-4 levels">
                        <label for="tech-med">Medieval (2pts/lvl):</label>
                        <input type="number" id="tech-med" name="tech-med" value="0" min="0" max="5"
                            aria-label="Medieval Tech Levels" title="0-5 levels">
                        <label for="tech-ind">Industrial (4pts/lvl):</label>
                        <input type="number" id="tech-ind" name="tech-ind" value="2" min="0" max="6"
                            aria-label="Industrial Tech Levels" title="0-6 levels">
                        <label for="tech-spacer">Spacer (8pts/lvl):</label>
                        <input type="number" id="tech-spacer" name="tech-spacer" value="0" min="0" max="7"
                            aria-label="Spacer Tech Levels" title="0-7 levels">
                        <div style="margin-top: 10px; font-weight: bold;" aria-live="polite">
                            Subtotal: <span id="tech-total">8</span> pts
                        </div>
                    </fieldset>

                    <!-- Building Points -->
                    <fieldset style="border: 1px solid #444; padding: 10px; border-radius: 5px;">
                        <legend style="margin-top: 0; color: var(--success); font-weight: bold;">Building Points
                        </legend>
                        <label for="build-barracks">Barracks (2pts):</label>
                        <input type="number" id="build-barracks" name="build-barracks" value="0" min="0"
                            aria-label="Number of Barracks">
                        <label for="build-kitchen">Kitchen (4pts):</label>
                        <input type="number" id="build-kitchen" name="build-kitchen" value="1" min="0"
                            aria-label="Number of Kitchens">
                        <label for="build-workshop">Workshop (6pts):</label>
                        <input type="number" id="build-workshop" name="build-workshop" value="0" min="0"
                            aria-label="Number of Workshops">
                        <label for="build-hospital">Hospital (8pts):</label>
                        <input type="number" id="build-hospital" name="build-hospital" value="0" min="0"
                            aria-label="Number of Hospitals">
                        <label for="build-lab">Research Lab (8pts):</label>
                        <input type="number" id="build-lab" name="build-lab" value="0" min="0"
                            aria-label="Number of Research Labs">
                        <div style="margin-top: 10px; font-weight: bold;" aria-live="polite">
                            Subtotal: <span id="build-total">4</span> pts
                        </div>
                    </fieldset>

                    <!-- Defense Points -->
                    <fieldset style="border: 1px solid #444; padding: 10px; border-radius: 5px;">
                        <legend style="margin-top: 0; color: var(--danger); font-weight: bold;">Defense Points</legend>
                        <label for="def-wood-wall">Wood Walls (0.5pts):</label>
                        <input type="number" id="def-wood-wall" name="def-wood-wall" value="0" min="0" step="1"
                            aria-label="Number of Wood Wall Sections">
                        <label for="def-stone-wall">Stone Walls (1pt):</label>
                        <input type="number" id="def-stone-wall" name="def-stone-wall" value="10" min="0"
                            aria-label="Number of Stone Wall Sections">
                        <label for="def-sandbags">Sandbags (0.5pts):</label>
                        <input type="number" id="def-sandbags" name="def-sandbags" value="0" min="0" step="1"
                            aria-label="Number of Sandbag Sections">
                        <label for="def-turret">Mini Turrets (5pts):</label>
                        <input type="number" id="def-turret" name="def-turret" value="1" min="0"
                            aria-label="Number of Mini Turrets">
                        <label for="def-mortar">Mortars (6pts):</label>
                        <input type="number" id="def-mortar" name="def-mortar" value="0" min="0"
                            aria-label="Number of Mortars">
                        <div style="margin-top: 10px; font-weight: bold;" aria-live="polite">
                            Subtotal: <span id="def-total">15</span> pts
                        </div>
                    </fieldset>

                    <!-- Colonist Points -->
                    <fieldset style="border: 1px solid #444; padding: 10px; border-radius: 5px;">
                        <legend style="margin-top: 0; color: var(--warning); font-weight: bold;">Colonist Points
                        </legend>
                        <label for="col-pcs">Player Characters (10pts):</label>
                        <input type="number" id="col-pcs" name="col-pcs" value="3" min="0"
                            aria-label="Number of Player Characters">
                        <label for="col-recruits">Recruits (5pts):</label>
                        <input type="number" id="col-recruits" name="col-recruits" value="0" min="0" max="4"
                            aria-label="Number of Recruits" title="Maximum 4 recruits">
                        <div style="margin-top: 10px; font-weight: bold;" aria-live="polite">
                            Subtotal: <span id="col-total">30</span> pts
                        </div>
                    </fieldset>
                </div>

                <!-- Total and Tier Display -->
                <div style="margin-top: 20px; padding: 15px; background: rgba(100,100,100,0.2); border-radius: 5px; text-align: center;"
                    role="status" aria-live="polite">
                    <div style="font-size: 1.5em; font-weight: bold;">
                        Total Wealth Score: <span id="wealth-score-display" style="color: var(--warning);">57</span>
                    </div>
                    <div style="font-size: 1.2em; margin-top: 5px;">
                        Colony Tier: <span id="colony-tier" style="color: var(--accent-color);">Prosperous</span>
                    </div>
                    <div style="margin-top: 5px; color: #aaa;">
                        Max Recruits: <span id="max-recruits">3</span> | Raid Points: <span id="raid-points">57</span>
                    </div>
                </div>
            </form>
        </section>

        <script>
            // ================================
            // Base Sheet Manager
            // ================================
            const BaseSheetManager = (function () {
                'use strict';

                // Constants
                const AUTOSAVE_KEY = 'rimworld_base_sheet_data';
                const AUTOSAVE_DEBOUNCE_MS = 1000;

                // Wealth tier thresholds
                const WEALTH_TIERS = [
                    { min: 100, name: 'Powerhouse', maxRecruits: 4 },
                    { min: 50, name: 'Prosperous', maxRecruits: 3 },
                    { min: 25, name: 'Established', maxRecruits: 2 },
                    { min: 10, name: 'Stable', maxRecruits: 1 },
                    { min: 0, name: 'Struggling', maxRecruits: 0 }
                ];

                // State
                let autosaveTimeout = null;
                let projectState = {};

                // Utility: Debounced function
                function debounce(func, wait) {
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(autosaveTimeout);
                            func(...args);
                        };
                        clearTimeout(autosaveTimeout);
                        autosaveTimeout = setTimeout(later, wait);
                    };
                }

                // Utility: Safe integer parse
                function safeParseInt(value, defaultValue = 0) {
                    const parsed = parseInt(value, 10);
                    return isNaN(parsed) ? defaultValue : parsed;
                }

                // Utility: Safe float parse
                function safeParseFloat(value, defaultValue = 0) {
                    const parsed = parseFloat(value);
                    return isNaN(parsed) ? defaultValue : parsed;
                }

                // Calculate wealth score
                function calculateWealth() {
                    try {
                        // Tech Points
                        const techNeo = safeParseInt(document.getElementById('tech-neo')?.value) * 1;
                        const techMed = safeParseInt(document.getElementById('tech-med')?.value) * 2;
                        const techInd = safeParseInt(document.getElementById('tech-ind')?.value) * 4;
                        const techSpacer = safeParseInt(document.getElementById('tech-spacer')?.value) * 8;
                        const techTotal = techNeo + techMed + techInd + techSpacer;

                        // Building Points
                        const buildBarracks = safeParseInt(document.getElementById('build-barracks')?.value) * 2;
                        const buildKitchen = safeParseInt(document.getElementById('build-kitchen')?.value) * 4;
                        const buildWorkshop = safeParseInt(document.getElementById('build-workshop')?.value) * 6;
                        const buildHospital = safeParseInt(document.getElementById('build-hospital')?.value) * 8;
                        const buildLab = safeParseInt(document.getElementById('build-lab')?.value) * 8;
                        const buildTotal = buildBarracks + buildKitchen + buildWorkshop + buildHospital + buildLab;

                        // Defense Points
                        const defWoodWall = safeParseInt(document.getElementById('def-wood-wall')?.value) * 0.5;
                        const defStoneWall = safeParseInt(document.getElementById('def-stone-wall')?.value) * 1;
                        const defSandbags = safeParseInt(document.getElementById('def-sandbags')?.value) * 0.5;
                        const defTurret = safeParseInt(document.getElementById('def-turret')?.value) * 5;
                        const defMortar = safeParseInt(document.getElementById('def-mortar')?.value) * 6;
                        const defTotal = defWoodWall + defStoneWall + defSandbags + defTurret + defMortar;

                        // Colonist Points
                        const colPCs = safeParseInt(document.getElementById('col-pcs')?.value) * 10;
                        const colRecruits = safeParseInt(document.getElementById('col-recruits')?.value) * 5;
                        const colTotal = colPCs + colRecruits;

                        // Total Wealth Score
                        const totalWealth = techTotal + buildTotal + defTotal + colTotal;

                        // Update subtotals
                        updateElement('tech-total', techTotal);
                        updateElement('build-total', buildTotal);
                        updateElement('def-total', defTotal);
                        updateElement('col-total', colTotal);

                        // Update total displays
                        updateElement('wealth-score-display', totalWealth);
                        updateElement('total-wealth-score', totalWealth);
                        updateElement('raid-points', totalWealth);

                        // Determine colony tier
                        const tierInfo = WEALTH_TIERS.find(tier => totalWealth >= tier.min) || WEALTH_TIERS[WEALTH_TIERS.length - 1];

                        updateElement('colony-tier', tierInfo.name);
                        updateElement('max-recruits', tierInfo.maxRecruits);
                        updateElement('wealth-tier-quick', tierInfo.name);

                        // Trigger autosave
                        debouncedAutosave();
                    } catch (error) {
                        console.error('Error calculating wealth:', error);
                    }
                }

                // Update element text content safely
                function updateElement(id, value) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                }

                // Update progress bar
                function updateBar(barId, current, max) {
                    const bar = document.getElementById(barId);
                    if (!bar) return;

                    const fill = bar.querySelector('.bar-fill');
                    if (!fill) return;

                    const percent = Math.min(100, Math.max(0, (current / max) * 100));
                    fill.style.width = percent + '%';

                    // Add visual feedback based on completion
                    if (percent >= 100) {
                        fill.style.background = 'var(--success)';
                    } else if (percent >= 75) {
                        fill.style.background = 'var(--warning)';
                    } else {
                        fill.style.background = 'var(--accent-color)';
                    }
                }

                // Add construction points to a project
                function addCP(projectId, amount) {
                    try {
                        const label = document.getElementById(projectId + '-label');
                        if (!label) return;

                        const text = label.textContent.trim();
                        // Parse "60/100 CP" format
                        const match = text.match(/(\d+)\s*\/\s*(\d+)\s*CP/);

                        if (!match) {
                            console.warn(`Could not parse CP format for: ${text}`);
                            return;
                        }

                        let current = safeParseInt(match[1]);
                        const max = safeParseInt(match[2]);

                        current = Math.min(current + amount, max);

                        label.textContent = `${current}/${max} CP`;
                        updateBar(projectId + '-bar', current, max);

                        // Save project state
                        projectState[projectId] = { current, max };
                        debouncedAutosave();

                        // Show feedback if project is complete
                        if (current >= max) {
                            showNotification(`${projectId} construction complete!`);
                        }
                    } catch (error) {
                        console.error('Error adding CP:', error);
                    }
                }

                // Show notification (simple implementation)
                function showNotification(message) {
                    console.log('Notification:', message);
                    // Could be enhanced with a toast notification UI
                }

                // Save data to localStorage
                function saveData() {
                    try {
                        const formData = new FormData(document.getElementById('wealth-calculator-form'));
                        const data = {
                            timestamp: new Date().toISOString(),
                            colonyName: document.getElementById('colony-name')?.value || '',
                            biome: document.getElementById('biome')?.value || '',
                            techLevel: document.getElementById('tech-level-display')?.value || '',
                            wealthInputs: Object.fromEntries(formData),
                            projects: projectState,
                            resources: getResourceData()
                        };
                        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(data));
                        console.log('Data autosaved at', new Date().toLocaleTimeString());
                    } catch (error) {
                        console.error('Error saving data:', error);
                    }
                }

                // Load data from localStorage
                function loadData() {
                    try {
                        const savedData = localStorage.getItem(AUTOSAVE_KEY);
                        if (!savedData) return false;

                        const data = JSON.parse(savedData);

                        // Restore basic info
                        if (data.colonyName) document.getElementById('colony-name').value = data.colonyName;
                        if (data.biome) document.getElementById('biome').value = data.biome;
                        if (data.techLevel) document.getElementById('tech-level-display').value = data.techLevel;

                        // Restore wealth inputs
                        if (data.wealthInputs) {
                            Object.entries(data.wealthInputs).forEach(([key, value]) => {
                                const input = document.getElementById(key);
                                if (input) input.value = value;
                            });
                        }

                        // Restore projects
                        if (data.projects) {
                            projectState = data.projects;
                            Object.entries(data.projects).forEach(([projectId, state]) => {
                                const label = document.getElementById(projectId + '-label');
                                if (label) {
                                    label.textContent = `${state.current}/${state.max} CP`;
                                    updateBar(projectId + '-bar', state.current, state.max);
                                }
                            });
                        }

                        // Restore resources
                        if (data.resources) {
                            setResourceData(data.resources);
                        }

                        console.log('Data loaded from', new Date(data.timestamp).toLocaleString());
                        return true;
                    } catch (error) {
                        console.error('Error loading data:', error);
                        return false;
                    }
                }

                // Get resource input values
                function getResourceData() {
                    const resources = {};
                    document.querySelectorAll('.resource-box input[type="number"]').forEach(input => {
                        if (input.id) {
                            resources[input.id] = input.value;
                        }
                    });
                    return resources;
                }

                // Set resource input values
                function setResourceData(resources) {
                    Object.entries(resources).forEach(([id, value]) => {
                        const input = document.getElementById(id);
                        if (input) input.value = value;
                    });
                }

                // Debounced autosave
                const debouncedAutosave = debounce(saveData, AUTOSAVE_DEBOUNCE_MS);

                // Initialize the sheet
                function init() {
                    console.log('Initializing Base Sheet Manager...');

                    // Try to load saved data
                    const dataLoaded = loadData();

                    // Calculate initial wealth (will use loaded or default values)
                    calculateWealth();

                    // Attach input listeners for autosave and recalculation
                    const wealthForm = document.getElementById('wealth-calculator-form');
                    if (wealthForm) {
                        wealthForm.addEventListener('input', (e) => {
                            if (e.target.tagName === 'INPUT') {
                                calculateWealth();
                            }
                        });
                    }

                    // Attach listeners to other inputs for autosave
                    ['colony-name', 'biome', 'tech-level-display'].forEach(id => {
                        const input = document.getElementById(id);
                        if (input) {
                            input.addEventListener('input', debouncedAutosave);
                        }
                    });

                    // Attach listeners to resource inputs
                    document.querySelectorAll('.resource-box input[type="number"]').forEach(input => {
                        input.addEventListener('input', debouncedAutosave);
                    });

                    // Keyboard shortcuts
                    document.addEventListener('keydown', (e) => {
                        // Ctrl/Cmd + S to manually save
                        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                            e.preventDefault();
                            saveData();
                            showNotification('Data saved manually');
                        }
                    });

                    console.log('Base Sheet Manager initialized!', dataLoaded ? '(Data loaded)' : '(Default values)');
                }

                // Public API
                return {
                    init,
                    calculateWealth,
                    updateBar,
                    addCP,
                    saveData,
                    loadData
                };
            })();

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', BaseSheetManager.init);
            } else {
                BaseSheetManager.init();
            }

            // Expose helper functions to global scope for inline onclick handlers
            window.addCP = BaseSheetManager.addCP;
            window.calculateWealth = BaseSheetManager.calculateWealth;
        </script>

        <!-- Defense Pool -->
        <section class="panel defense-pool" aria-labelledby="defense-pool-heading">
            <h2 id="defense-pool-heading" style="color: #ffaaaa; font-size: 1.2em; margin: 0;">DEFENSE POOL</h2>
            <div class="defense-value" aria-label="Defense Pool Current and Maximum">12 / 12</div>
            <p style="color: #aaa; margin: 5px 0 0 0;">Spend points to negate hits or reduce damage.</p>
        </section>

        <!-- Resources -->
        <section class="panel" style="grid-column: span 12;" aria-labelledby="resources-heading">
            <h2 id="resources-heading">Resources</h2>
            <div class="resource-grid">
                <div class="resource-box">
                    <label for="resource-food">Food</label>
                    <input type="number" id="resource-food" name="resource-food" value="50" min="0"
                        aria-label="Food Quantity">
                    <span style="font-size: 0.8em; color: #888;" role="note">Days: 5</span>
                </div>
                <div class="resource-box">
                    <label for="resource-textiles">Textiles</label>
                    <input type="number" id="resource-textiles" name="resource-textiles" value="20" min="0"
                        aria-label="Textiles Quantity">
                </div>
                <div class="resource-box">
                    <label for="resource-ore">Ore</label>
                    <input type="number" id="resource-ore" name="resource-ore" value="100" min="0"
                        aria-label="Ore Quantity">
                </div>
                <div class="resource-box">
                    <label for="resource-components">Components</label>
                    <input type="number" id="resource-components" name="resource-components" value="5" min="0"
                        aria-label="Components Quantity">
                </div>
                <div class="resource-box">
                    <label for="resource-medicine">Medicine</label>
                    <input type="number" id="resource-medicine" name="resource-medicine" value="10" min="0"
                        aria-label="Medicine Quantity">
                </div>
            </div>
        </section>

        <!-- Facilities -->
        <section class="panel" style="grid-column: span 8;" aria-labelledby="facilities-heading">
            <h2 id="facilities-heading">Facilities Grid</h2>
            <div class="facility-grid" role="list" aria-label="Colony Facilities">
                <div class="facility" role="listitem">Barracks (Wood)</div>
                <div class="facility" role="listitem">Kitchen (Steel)</div>
                <div class="facility" role="listitem">Freezer</div>
                <div class="facility" role="listitem">Workshop</div>
                <div class="facility" role="listitem">Hospital</div>
                <div class="facility" role="listitem" style="border-style: dashed; color: #666;">Empty Plot</div>
                <div class="facility" role="listitem" style="border-style: dashed; color: #666;">Empty Plot</div>
                <div class="facility" role="listitem" style="border-style: dashed; color: #666;">Empty Plot</div>
            </div>
            <h3 id="defensive-line-heading">Defensive Line</h3>
            <div class="facility-grid" role="list" aria-labelledby="defensive-line-heading">
                <div class="facility" role="listitem" style="border-color: var(--danger);">Mini-Turret</div>
                <div class="facility" role="listitem" style="border-color: var(--danger);">Sandbags</div>
                <div class="facility" role="listitem" style="border-color: var(--danger);">Sandbags</div>
                <div class="facility" role="listitem" style="border-color: var(--danger);">Spike Trap</div>
            </div>
        </section>

        <!-- Active Projects -->
        <section class="panel" style="grid-column: span 4;" aria-labelledby="construction-queue-heading">
            <h2 id="construction-queue-heading">Construction Queue</h2>

            <article class="active-project" aria-labelledby="proj1-name">
                <div style="display: flex; justify-content: space-between;">
                    <strong id="proj1-name">Killbox Walls</strong>
                    <span id="proj1-label" aria-live="polite" aria-label="Construction Progress">60/100 CP</span>
                </div>
                <div class="bar-container" id="proj1-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0"
                    aria-valuemax="100">
                    <div class="bar-fill" style="width: 60%; background: var(--warning);"></div>
                </div>
                <div class="project-controls" role="group" aria-label="Add Construction Points">
                    <button onclick="addCP('proj1', 1)" aria-label="Add 1 Construction Point">+1 CP</button>
                    <button onclick="addCP('proj1', 5)" aria-label="Add 5 Construction Points">+5 CP</button>
                    <button onclick="addCP('proj1', 10)" aria-label="Add 10 Construction Points">+10 CP</button>
                </div>
            </article>

            <article class="active-project" aria-labelledby="proj2-name">
                <div style="display: flex; justify-content: space-between;">
                    <strong id="proj2-name">Solar Panel</strong>
                    <span id="proj2-label" aria-live="polite" aria-label="Construction Progress">0/200 CP</span>
                </div>
                <div class="bar-container" id="proj2-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                    aria-valuemax="200">
                    <div class="bar-fill" style="width: 0%; background: var(--warning);"></div>
                </div>
                <div class="project-controls" role="group" aria-label="Add Construction Points">
                    <button onclick="addCP('proj2', 5)" aria-label="Add 5 Construction Points">+5 CP</button>
                    <button onclick="addCP('proj2', 20)" aria-label="Add 20 Construction Points">+20 CP</button>
                </div>
            </article>

        </section>

    </div>
</body>

</html>